<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Translation</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      font-family: sans-serif;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wrapper {
      text-align: center;
      width: 90%;
      max-width: 800px;
    }

    h1 {
      color: #0ea5e9;
    }

    #output {
      margin-top: 30px;
      background: #e2e8f0;
      padding: 16px;
      border-radius: 10px;
      height: 400px;
      overflow-y: auto;
      text-align: left;
    }

    .pair {
      margin-bottom: 20px; /* space between transcript+translation blocks */
      padding-bottom: 10px;
      border-bottom: 1px solid #cbd5e1;
    }

    .transcript {
      font-weight: bold;
      margin-bottom: 6px;
      color: #111827;
    }

    .translation {
      color: #334155;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Worship On Air - AI Translation</h1>
    <p><em>English ‚Üí Korean</em></p>

    <div id="output"></div>
  </div>

<!-- Azure Speech SDK (browser) -->
<script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>

<button id="startBtn">üéôÔ∏è Start Microphone</button>
<div id="status" style="margin-top:8px;color:#334155;"></div>
<div id="output" class="container"></div>

<script>
const statusEl = document.getElementById("status");
const outputEl = document.getElementById("output");
const startBtn = document.getElementById("startBtn");

const scheme = location.protocol === "https:" ? "wss" : "ws";
const ws = new WebSocket(`${scheme}://${location.host}/ws`);
ws.addEventListener("open", () => status("WS connected"));
ws.addEventListener("error", () => status("WS error", true));

function status(msg, err=false){
  statusEl.textContent = msg;
  statusEl.style.color = err ? "#b91c1c" : "#334155";
}
function addPair(src, dst){
  const pair = document.createElement("div");
  pair.className = "pair";
  const t1 = document.createElement("div");
  t1.className = "transcript"; t1.textContent = src;
  const t2 = document.createElement("div");
  t2.className = "translation"; t2.textContent = dst;
  pair.appendChild(t1); pair.appendChild(t2);
  outputEl.appendChild(pair);
  outputEl.scrollTop = outputEl.scrollHeight;
}
// Receive server broadcasts (what all viewers see)
ws.onmessage = (ev) => {
  try {
    const { transcript, translation } = JSON.parse(ev.data);
    addPair(transcript, translation);
  } catch { /* ignore */ }
};

startBtn.addEventListener("click", async () => {
  if (!window.isSecureContext) status("‚ö†Ô∏è Use HTTPS for mic access", true);

  // 1) Ask your backend for a short-lived token
  const token = await fetch("/speech/token", { method: "POST" }).then(r => r.text());
  if (!token) return status("Token error", true);

  // 2) Init SDK (set your source language here)
  const region = "<YOUR_SPEECH_REGION>"; // e.g., "westus2" (same as SPEECH_REGION)
  const speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(token, region);
  speechConfig.speechRecognitionLanguage = "en-US"; // source language

  // 3) Use default mic
  const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
  const recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

  // Refresh token before 10 min expiry
  setInterval(async () => {
    try {
      const t = await fetch("/speech/token", { method: "POST" }).then(r => r.text());
      recognizer.authorizationToken = t;
    } catch {}
  }, 9 * 60 * 1000);

  recognizer.recognizing = (_s, e) => { status("Listening‚Ä¶ " + (e.result?.text || "")); };
  recognizer.canceled = (_s, e) => status("Canceled: " + e.errorDetails, true);
  recognizer.sessionStopped = () => status("Stopped");

  // 4) On each final result, POST to the server for translation+broadcast
  recognizer.recognized = async (_s, e) => {
    const text = e.result?.text?.trim();
    if (!text) return;
    try {
      await fetch("/publish", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ text, from: "en", to: "ko" }) // change target as needed
      });
    } catch {
      status("Publish failed", true);
    }
  };

  recognizer.startContinuousRecognitionAsync(
    () => status("üé§ Mic active. Speak now."),
    (err) => status("Start error: " + err, true)
  );
});
</script>




</body>
</html>