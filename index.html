<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Translation</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      font-family: sans-serif;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wrapper {
      text-align: center;
      width: 90%;
      max-width: 800px;
    }

    h1 {
      color: #0ea5e9;
    }

    #output {
      margin-top: 30px;
      background: #e2e8f0;
      padding: 16px;
      border-radius: 10px;
      height: 400px;
      overflow-y: auto;
      text-align: left;
    }

    .pair {
      margin-bottom: 20px; /* space between transcript+translation blocks */
      padding-bottom: 10px;
      border-bottom: 1px solid #cbd5e1;
    }

    .transcript {
      font-weight: bold;
      margin-bottom: 6px;
      color: #111827;
    }

    .translation {
      color: #334155;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Worship On Air - AI Translation</h1>
    <p><em>English â†’ Korean</em></p>

    <div id="output"></div>
  </div>

<script>
const ws = new WebSocket("wss://YOUR_AZURE_APP_NAME.azurewebsites.net/ws/translate");

ws.onopen = async () => {
  console.log("Connected to server.");

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const audioContext = new AudioContext();
  const source = audioContext.createMediaStreamSource(stream);
  const processor = audioContext.createScriptProcessor(4096, 1, 1);

  source.connect(processor);
  processor.connect(audioContext.destination);

  processor.onaudioprocess = (e) => {
    const input = e.inputBuffer.getChannelData(0);
    // Convert Float32 to PCM16
    const buffer = new ArrayBuffer(input.length * 2);
    const view = new DataView(buffer);
    let offset = 0;
    for (let i = 0; i < input.length; i++, offset += 2) {
      let s = Math.max(-1, Math.min(1, input[i]));
      view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7fff, true);
    }
    // Send base64 to server
    ws.send(JSON.stringify({ audio_base64: Array.from(new Uint8Array(buffer)).map(b => b.toString(16)).join('') }));
  };
};

ws.onmessage = (e) => {
  try {
    const data = JSON.parse(e.data);
    if (data.transcript && data.translation) {
      console.log("Transcript:", data.transcript);
      console.log("Translation:", data.translation);
    }
  } catch {}
};
</script>

</body>
</html>