<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Translation</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      font-family: sans-serif;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wrapper {
      text-align: center;
      width: 90%;
      max-width: 800px;
    }

    h1 {
      color: #0ea5e9;
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }

    .status.connected {
      background: #dcfce7;
      color: #166534;
    }

    .status.error {
      background: #fecaca;
      color: #991b1b;
    }

    .status.listening {
      background: #dbeafe;
      color: #1e40af;
    }

    #output {
      margin-top: 30px;
      background: #e2e8f0;
      padding: 16px;
      border-radius: 10px;
      height: 400px;
      overflow-y: auto;
      text-align: left;
    }

    .pair {
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #cbd5e1;
    }

    .transcript {
      font-weight: bold;
      margin-bottom: 6px;
      color: #111827;
    }

    .translation {
      color: #334155;
    }

    .recognizing {
      opacity: 0.7;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Worship On Air - AI Translation</h1>
    <p><em>English â†’ Korean</em></p>
    
    <div id="status" class="status">Connecting...</div>
    
    <div id="output"></div>
  </div>

<script>
  const scheme = location.protocol === "https:" ? "wss" : "ws";
  const wsUrl = `${scheme}://${location.host}/ws/translate`;
  const ws = new WebSocket(wsUrl);
  
  const output = document.getElementById("output");
  const status = document.getElementById("status");
  
  let currentRecognizingElement = null;

  ws.onopen = () => {
    status.textContent = "Connected - Waiting for speech...";
    status.className = "status connected";
  };

  ws.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      console.log("Received:", data);
      
      switch(data.type) {
        case "status":
          status.textContent = data.message;
          status.className = "status listening";
          break;
          
        case "recognizing":
          // Show intermediate results
          if (data.transcript) {
            if (!currentRecognizingElement) {
              currentRecognizingElement = document.createElement("div");
              currentRecognizingElement.className = "pair recognizing";
              output.appendChild(currentRecognizingElement);
            }
            
            currentRecognizingElement.innerHTML = `
              <div class="transcript">${data.transcript}</div>
              <div class="translation">${data.translation}</div>
            `;
            output.scrollTop = output.scrollHeight;
          }
          break;
          
        case "recognized":
          // Show final results
          if (currentRecognizingElement) {
            currentRecognizingElement.remove();
            currentRecognizingElement = null;
          }
          
          if (data.transcript) {
            const pair = document.createElement("div");
            pair.className = "pair";
            pair.innerHTML = `
              <div class="transcript">${data.transcript}</div>
              <div class="translation">${data.translation}</div>
            `;
            output.appendChild(pair);
            output.scrollTop = output.scrollHeight;
          }
          break;
          
        case "error":
          status.textContent = `Error: ${data.message}`;
          status.className = "status error";
          console.error("Error:", data.message);
          break;
      }
    } catch (e) {
      console.warn("Non-JSON message:", event.data);
    }
  };

  ws.onerror = (error) => {
    console.error("WebSocket error:", error);
    status.textContent = "Connection error";
    status.className = "status error";
  };

  ws.onclose = () => {
    status.textContent = "Connection closed";
    status.className = "status error";
  };
</script>
</body>
</html>