<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Worship On Air - AI Translation</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      font-family: sans-serif;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wrapper {
      text-align: center;
      width: 90%;
      max-width: 800px;
    }

    h1 {
      color: #0ea5e9;
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }

    .status.listening {
      background: #dbeafe;
      color: #1e40af;
    }

    .status.error {
      background: #fecaca;
      color: #991b1b;
    }

    .status.success {
      background: #dcfce7;
      color: #166534;
    }

    .status.initializing {
      background: #fef3c7;
      color: #92400e;
    }

    #output {
      margin-top: 30px;
      background: #e2e8f0;
      padding: 16px;
      border-radius: 10px;
      height: 400px;
      overflow-y: auto;
      text-align: left;
    }

    .pair {
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #cbd5e1;
    }

    .transcript {
      font-weight: bold;
      margin-bottom: 6px;
      color: #111827;
    }

    .translation {
      color: #334155;
    }

    .interim {
      opacity: 0.7;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Worship On Air - AI Translation</h1>

    <!-- Role selection -->
    <div id="roleSelection">
      <p>Are you an Admin or Client?</p>
      <button onclick="chooseRole('admin')">Admin</button>
      <button onclick="chooseRole('client')">Client</button>
    </div>

    <!-- Admin password input -->
    <div id="adminLogin" style="display:none;">
      <p>Enter Admin Password:</p>
      <input type="password" id="adminPassword" />
      <button onclick="verifyPassword()">Login</button>
      <p id="loginError" style="color:red;"></p>
    </div>

    <!-- Translation output -->
    <div id="translationArea" style="display:none;">
      <div id="status" class="status initializing">Waiting...</div>
      <div id="output"></div>
    </div>
  </div>

<script>
  let userRole = null;
  let isAdmin = false;
  let ws;

  function chooseRole(role) {
    userRole = role;
    document.getElementById('roleSelection').style.display = 'none';
    if (role === 'admin') {
      document.getElementById('adminLogin').style.display = 'block';
    } else {
      startClientMode();
    }
  }

  function verifyPassword() {
    const pwd = document.getElementById('adminPassword').value;
    if (pwd === 'Joshua') {
      isAdmin = true;
      document.getElementById('adminLogin').style.display = 'none';
      startAdminMode();
    } else {
      document.getElementById('loginError').textContent = 'Wrong password';
    }
  }

  function startAdminMode() {
    document.getElementById('translationArea').style.display = 'block';
    initRecognition();
    setupWebSocket();
  }

  function startClientMode() {
    document.getElementById('translationArea').style.display = 'block';
    setupWebSocket();
  }

  function setupWebSocket() {
    const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
    ws = new WebSocket(`${proto}://${window.location.host}/ws`);
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (!isAdmin) {
        // Clients display received translations
        displayTranslation(data.transcript, data.translation);
      }
    };
  }

  function displayTranslation(transcript, translation) {
    const output = document.getElementById('output');
    const pair = document.createElement('div');
    pair.className = 'pair';
    pair.innerHTML = `
      <div class="transcript">${transcript}</div>
      <div class="translation">${translation}</div>
    `;
    output.appendChild(pair);
    output.scrollTop = output.scrollHeight;
  }

  // Speech recognition for Admin
  function initRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    const status = document.getElementById('status');
    const output = document.getElementById('output');
    let interimElement = null;

    recognition.onstart = () => {
      status.textContent = 'Listening...';
      status.className = 'status listening';
    };

    recognition.onerror = (event) => {
      console.error('Speech recognition error:', event.error);
      status.textContent = 'Error: ' + event.error;
      status.className = 'status error';
    };

    recognition.onresult = async (event) => {
      let finalTranscript = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        if (event.results[i].isFinal) {
          finalTranscript += event.results[i][0].transcript;
        }
      }

      if (finalTranscript.trim()) {
        try {
          const translation = await translateText(finalTranscript.trim());

          // Show locally for admin
          displayTranslation(finalTranscript.trim(), translation);

          // Send to clients
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
              transcript: finalTranscript.trim(),
              translation: translation
            }));
          }
        } catch (error) {
          console.error('Translation error:', error);
        }
      }
    };

    recognition.start();
  }

  async function translateText(text) {
    try {
      const response = await fetch('/api/translate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: text, from: 'en', to: 'ko' })
      });
      const data = await response.json();
      return data.translation;
    } catch (err) {
      console.error('Translation API error:', err);
      return 'Translation failed';
    }
  }
</script>
</body>
</html>